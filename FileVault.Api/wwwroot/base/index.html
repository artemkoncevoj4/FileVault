<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileVault - –û–±–ª–∞–∫–æ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #1c1e21; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .file-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <h1>‚òÅÔ∏è FileVault Storage</h1>

    <div id="auth-panel" class="panel">
        <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
        <input type="text" id="loginInput" placeholder="–í–∞—à –ª–æ–≥–∏–Ω">
        <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()">–í–æ–π—Ç–∏</button>
        <button onclick="register()" class="btn-success">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <p id="auth-msg" style="color: red;"></p>
    </div>

    <div id="profile-panel" class="panel hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="welcomeText">–ü—Ä–∏–≤–µ—Ç!</h2>
            <button onclick="logout()" class="btn-danger">–í—ã–π—Ç–∏</button>
        </div>
        <p>–í–∞—à —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞: <b id="userLevel"></b></p>
    </div>

    <div id="files-panel" class="panel hidden">
        <h2>üìÇ –ú–æ–∏ —Ñ–∞–π–ª—ã</h2>
        <div id="upload-section" class="hidden">
            <p style="color: green;">‚úì –í–∞–º –¥–æ—Å—Ç—É–ø–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (—É—Ä–æ–≤–µ–Ω—å 3+)</p>
            <input type="file" id="fileInput">
            <button onclick="uploadFile()">–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
        </div>
        <hr>
        <div id="file-list">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤...</p>
            </div>
    </div>

    <div id="admin-panel" class="panel hidden" style="border: 2px solid #ffc107;">
        <h2>üëë –ê–¥–º–∏–Ω-—Ü–µ–Ω—Ç—Ä</h2>
        <table>
            <thead><tr><th>ID</th><th>–õ–æ–≥–∏–Ω</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
            <tbody id="usersTable"></tbody>
        </table>
    </div>
</div>
<div id="rename-modal" class="panel hidden" style="position: fixed; top: 30%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; border: 2px solid #17a2b8; box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 400px; max-width: 90%;">
        <h3>‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ–∞–π–ª</h3>
        <p style="color: gray; font-size: 14px; word-break: break-all;">–°—Ç–∞—Ä–æ–µ –∏–º—è: <b id="renameOldNameDisplay"></b></p>
        <input type="text" id="renameInput" placeholder="–ù–æ–≤–æ–µ –∏–º—è (–±–µ–∑ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è)">
        <div style="margin-top: 15px; text-align: right;">
            <button onclick="closeRenameModal()" style="background: #6c757d;">–û—Ç–º–µ–Ω–∞</button>
            <button onclick="confirmRename()" class="btn-success" style="margin-left: 5px;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
<script>
    // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –¢–æ–∫–µ–Ω–æ–º
    async function apiRequest(url, method = 'GET', body = null) {
        console.log(`[API] –ó–∞–ø—Ä–æ—Å: ${method} ${url}`, body); // –õ–û–ì –í –ö–û–ù–°–û–õ–¨
        const token = localStorage.getItem('vault_token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        try {
            const response = await fetch(url, options);
            console.log(`[API] –û—Ç–≤–µ—Ç –æ—Ç ${url}: ${response.status}`);
            if (response.status === 401 || response.status === 403) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞ (401/403)");
            }
            return response;
        } catch (e) {
            console.error("[API] –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ fetch:", e);
            return { ok: false };
        }
    }

    async function login() {
        const login = document.getElementById('loginInput').value;
        const password = document.getElementById('passwordInput').value;

        const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ login, password })
        });

        if (res.ok) {
            const data = await res.json();
            localStorage.setItem('vault_token', data.token); // –°–æ—Ö—Ä–∞–Ω—è–µ–º "–ø–∞—Å–ø–æ—Ä—Ç"
            localStorage.setItem('vault_user', JSON.stringify(data.user));
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º, —á—Ç–æ–±—ã UI –æ–±–Ω–æ–≤–∏–ª—Å—è
        } else {
            document.getElementById('auth-msg').innerText = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
        }
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }
    async function register() {
        const login = document.getElementById('loginInput').value;
        const password = document.getElementById('passwordInput').value;

        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ login, password })
        });

        if (response.ok) {
            alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
        } else {
            const error = await response.text();
            alert("–û—à–∏–±–∫–∞: " + error);
        }
    }
    async function deleteUser(userId) {
        console.log("–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID:", userId);
        // if (!confirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${userId}?`)) return;

        const res = await apiRequest(`/api/admin/users/${userId}`, 'DELETE');
        if (res.ok) {
            alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω");
            loadAdminData();
        } else {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        }
    }
    async function uploadFile() {
        const fileInput = document.getElementById('fileInput');
        if (fileInput.files.length === 0) return;

        const formData = new FormData();
        formData.append('file', fileInput.files[0]);

        const token = localStorage.getItem('vault_token');

        // –ò—Å–ø–æ–ª—å–∑—É–µ–º fetch –Ω–∞–ø—Ä—è–º—É—é, —Ç–∞–∫ –∫–∞–∫ FormData –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É–µ—Ç —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º JSON –≤ apiRequest
        const res = await fetch('/api/files/upload', {
            method: 'POST',
            headers: { 
                'Authorization': `Bearer ${token}`
                // Content-Type –ù–ï –ü–ò–®–ï–ú!
            },
            body: formData
        });

        if (res.ok) {
            alert("–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –Ω–∞ –¥–∏—Å–∫!");
            fileInput.value = "";
            loadFiles(); 
        } else {
            const err = await res.text();
            alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: " + err);
        }
    }
    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = async () => {
        const userJson = localStorage.getItem('vault_user');
        if (!userJson) return;

        const user = JSON.parse(userJson);
        const lvl = user.accessLevel;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –±–ª–æ–∫–∏
        document.getElementById('auth-panel').classList.add('hidden');
        document.getElementById('profile-panel').classList.remove('hidden');
        document.getElementById('files-panel').classList.remove('hidden');
        
        document.getElementById('welcomeText').innerText = `–ü—Ä–∏–≤–µ—Ç, ${user.login}!`;
        document.getElementById('userLevel').innerText = lvl;

        // –†–ê–ó–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –î–û–°–¢–£–ü–ê –í –ò–ù–¢–ï–†–§–ï–ô–°–ï
        if (lvl >= 3) {
            document.getElementById('upload-section').classList.remove('hidden');
        }

        if (lvl === 5) {
            document.getElementById('admin-panel').classList.remove('hidden');
            loadAdminData();
        }
        
        loadFiles();
    };

    async function loadAdminData() {
        const res = await apiRequest('/api/admin/users');
        if (res.ok) {
            const users = await res.json();
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.login}</td>
                        <td><input type="number" value="${u.accessLevel}" id="lvl-${u.id}" style="width:50px"></td>
                        <td>
                            <button onclick="changeLevel(${u.id})" class="btn-success">–û–ö</button>
                            <button onclick="deleteUser(${u.id})" class="btn-danger" style="padding: 5px 10px;">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
            `).join('');
        }
    }

    async function changeLevel(userId) {
        const newLvl = document.getElementById(`lvl-${userId}`).value;
        const res = await apiRequest(`/api/admin/users/${userId}/access`, 'PUT', parseInt(newLvl));
        if (res.ok) alert("–£—Ä–æ–≤–µ–Ω—å –∏–∑–º–µ–Ω–µ–Ω!");
    }

        async function loadFiles() {
            const list = document.getElementById('file-list');
            const user = JSON.parse(localStorage.getItem('vault_user'));
            const lvl = user.accessLevel;
            const currentUserId = user.id;

            const res = await apiRequest('/api/files/list');
            if (res.ok) {
                const files = await res.json();
                list.innerHTML = files.map(fileName => {
                    const isLocked = fileName.startsWith('locked_');
                    
                    // –†–∞–∑–±–∏—Ä–∞–µ–º –∏–º—è –¥–ª—è –ø–æ–∫–∞–∑–∞
                    let cleanName = isLocked ? fileName.replace('locked_', '') : fileName;
                    const parts = cleanName.split('_');
                    const ownerId = parts[0];
                    const realDisplayName = parts.slice(1).join('_');
                    
                    const isOwner = ownerId == currentUserId;
                    const isAdmin = lvl === 5;

                    // –ö–æ–¥–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ –≤ Base64, —á—Ç–æ–±—ã —Å–ø–µ—Ü—Å–∏–º–≤–æ–ª—ã –Ω–µ –ª–æ–º–∞–ª–∏ onclick
                    const b64Name = btoa(unescape(encodeURIComponent(fileName)));

                    return `
                    <div class="file-item" style="${isLocked ? 'background: #fff3cd;' : ''}">
                        <div>
                            <span>${isLocked ? 'üîí' : 'üìÑ'} <b>${realDisplayName}</b></span>
                            <br><small style="color: gray;">–í–ª–∞–¥–µ–ª–µ—Ü: #${ownerId} ${isOwner ? '(–í—ã)' : ''}</small>
                        </div>
                        <div>
                            ${lvl >= 2 ? `<button onclick="safeAction('download', '${b64Name}')" class="btn-success">–°–∫–∞—á–∞—Ç—å</button>` : ''}
                            
                            ${lvl >= 4 ? 
                                (isLocked ? 
                                    `<button onclick="safeAction('unlock', '${b64Name}')" style="background: #007bff; margin-left: 5px;">–û—Ç–∫—Ä—ã—Ç—å</button>` : 
                                    `<button onclick="safeAction('lock', '${b64Name}')" style="background: #6c757d; margin-left: 5px;">–ó–∞–∫—Ä—ã—Ç—å</button>`) 
                                : ''}

                            ${(lvl >= 3 && isOwner) || isAdmin ? 
                                `<button onclick="safeAction('rename', '${b64Name}')" style="background: #17a2b8; margin-left: 5px;">‚úèÔ∏è</button>` : ''}
                            
                            ${(lvl >= 3 && isOwner) || isAdmin ? 
                                `<button onclick="safeAction('delete', '${b64Name}')" class="btn-danger" style="margin-left: 5px;">–£–¥–∞–ª–∏—Ç—å</button>` : ''}
                        </div>
                    </div>`;
                }).join('');
            }
        }
        function safeAction(action, b64Name) {
            const fileName = decodeURIComponent(escape(atob(b64Name)));
            console.log(`–î–µ–π—Å—Ç–≤–∏–µ: ${action} –¥–ª—è —Ñ–∞–π–ª–∞: ${fileName}`);

            if (action === 'download') downloadFile(fileName);
            if (action === 'lock') lockFile(fileName);
            if (action === 'unlock') unlockFile(fileName);
            if (action === 'delete') deleteFileOnServer(fileName);
            if (action === 'rename') renamePrompt(fileName); // –¢–æ—Ç —Å–∞–º—ã–π prompt
        }
        async function lockFile(fileName) {
            const res = await apiRequest(`/api/files/lock/${fileName}`, 'PUT');
            if (res.ok) {
                alert("–§–∞–π–ª –∑–∞–∫—Ä—ã—Ç –¥–ª—è —É—Ä–æ–≤–Ω–µ–π –Ω–∏–∂–µ 4");
                loadFiles();
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞");
            }
        }
        async function unlockFile(fileName) {
            const res = await apiRequest(`/api/files/unlock/${fileName}`, 'PUT');
            if (res.ok) {
                alert("–§–∞–π–ª —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–º");
                loadFiles();
            } else {
                alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ñ–∞–π–ª–∞");
            }
        }
        let currentFileToRename = "";

        // 1. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—à–µ –∫—Ä–∞—Å–∏–≤–æ–µ –æ–∫–Ω–æ
        function renamePrompt(oldName) {
            currentFileToRename = oldName;
            document.getElementById('renameOldNameDisplay').innerText = oldName;
            document.getElementById('renameInput').value = ""; // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            document.getElementById('rename-modal').classList.remove('hidden'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ
        }

        // 2. –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ, –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ "–û—Ç–º–µ–Ω–∞"
        function closeRenameModal() {
            document.getElementById('rename-modal').classList.add('hidden');
            currentFileToRename = "";
        }

        // 3. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –∫–æ–≥–¥–∞ –Ω–∞–∂–∞–ª–∏ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
        async function confirmRename() {
            const newNameRaw = document.getElementById('renameInput').value.trim();
            const oldName = currentFileToRename;

            if (!newNameRaw) {
                alert("–ò–º—è –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º!");
                return;
            }

            // –ê–≤—Ç–æ-—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (—á—Ç–æ–±—ã —é–∑–µ—Ä –µ–≥–æ –Ω–µ –ø–æ—Ç–µ—Ä—è–ª)
            const ext = oldName.includes('.') ? oldName.substring(oldName.lastIndexOf('.')) : '';
            let newName = newNameRaw.endsWith(ext) ? newNameRaw : newNameRaw + ext;

            // –ü—Ä—è—á–µ–º –æ–∫–Ω–æ
            closeRenameModal();

            // –õ–µ—Ç–∏–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const res = await apiRequest('/api/files/rename', 'PUT', { 
                OldName: oldName, 
                NewName: newName 
            });

            if (res.ok) {
                alert("–§–∞–π–ª –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω!");
                loadFiles(); // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Å–ø–∏—Å–æ–∫
            } else {
                const err = await res.text();
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + err);
            }
        }
        async function downloadFile(fileName) {
        const token = localStorage.getItem('vault_token');
        
        // –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ API —Å —Ç–æ–∫–µ–Ω–æ–º –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å Blob
        const res = await fetch(`/api/files/download/${fileName}`, {
            headers: { 'Authorization': `Bearer ${token}` }
        });

        if (res.ok) {
            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName; // –ò–º—è —Ñ–∞–π–ª–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏
            document.body.appendChild(a);
            a.click();
            a.remove();
        } else {
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏");
        }
    }

    async function deleteFileOnServer(fileName) {
        console.log("–ü–æ–ø—ã—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ñ–∞–π–ª–∞:", fileName);
        
        // // –ü–†–û–í–ï–†–ö–ê: –ï—Å–ª–∏ confirm –ø–æ –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–∏—á–∏–Ω–µ –≥–ª—é—á–∏—Ç, –º—ã —ç—Ç–æ —É–≤–∏–¥–∏–º
        // if (!confirm(`–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ñ–∞–π–ª ${fileName}?`)) {
        //     console.log("–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º");
        //     return;
        // }

        // –í–ê–ñ–ù–û: —É–±–µ–¥–∏—Å—å, —á—Ç–æ –≤ FilesController –ø—É—Ç—å –∏–º–µ–Ω–Ω–æ —Ç–∞–∫–æ–π!
        const res = await apiRequest(`/api/files/delete/${fileName}`, 'DELETE');
        
        if (res.ok) {
            alert("–§–∞–π–ª —É–¥–∞–ª–µ–Ω");
            await loadFiles(); 
        } else {
            const err = await res.text();
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: " + err);
        }
    }
    
</script>
</body>
</html>