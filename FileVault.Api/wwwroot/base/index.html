<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FileVault - –û–±–ª–∞–∫–æ</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; color: #1c1e21; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .hidden { display: none; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { background: #007bff; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; transition: 0.3s; }
        button:hover { background: #0056b3; }
        .btn-danger { background: #dc3545; }
        .btn-success { background: #28a745; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
        .file-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 5px; border-radius: 4px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="container">
    <h1>‚òÅÔ∏è FileVault Storage</h1>

    <div id="auth-panel" class="panel">
        <h2>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
        <input type="text" id="loginInput" placeholder="–í–∞—à –ª–æ–≥–∏–Ω">
        <input type="password" id="passwordInput" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="login()">–í–æ–π—Ç–∏</button>
        <button onclick="register()" class="btn-success">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</button>
        <p id="auth-msg" style="color: red;"></p>
    </div>

    <div id="profile-panel" class="panel hidden">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h2 id="welcomeText">–ü—Ä–∏–≤–µ—Ç!</h2>
            <button onclick="logout()" class="btn-danger">–í—ã–π—Ç–∏</button>
        </div>
        <p>–í–∞—à —É—Ä–æ–≤–µ–Ω—å –¥–æ—Å—Ç—É–ø–∞: <b id="userLevel"></b></p>
    </div>

    <div id="files-panel" class="panel hidden">
        <h2>üìÇ –ú–æ–∏ —Ñ–∞–π–ª—ã</h2>
        <div id="upload-section" class="hidden">
            <p style="color: green;">‚úì –í–∞–º –¥–æ—Å—Ç—É–ø–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ (—É—Ä–æ–≤–µ–Ω—å 3+)</p>
            <input type="file" id="fileInput">
            <button onclick="alert('–¢—É—Ç –±—É–¥–µ—Ç –ª–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏!')">–ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞ —Å–µ—Ä–≤–µ—Ä</button>
        </div>
        <hr>
        <div id="file-list">
            <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤...</p>
            </div>
    </div>

    <div id="admin-panel" class="panel hidden" style="border: 2px solid #ffc107;">
        <h2>üëë –ê–¥–º–∏–Ω-—Ü–µ–Ω—Ç—Ä</h2>
        <table>
            <thead><tr><th>ID</th><th>–õ–æ–≥–∏–Ω</th><th>–£—Ä–æ–≤–µ–Ω—å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
            <tbody id="usersTable"></tbody>
        </table>
    </div>
</div>

<script>
    // –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å –¢–æ–∫–µ–Ω–æ–º
    async function apiRequest(url, method = 'GET', body = null) {
        const token = localStorage.getItem('vault_token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        const response = await fetch(url, options);
        if (response.status === 401 || response.status === 403) {
            console.error("–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞!");
        }
        return response;
    }

    async function login() {
        const login = document.getElementById('loginInput').value;
        const password = document.getElementById('passwordInput').value;

        const res = await fetch('/api/auth/login', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ login, password })
        });

        if (res.ok) {
            const data = await res.json();
            localStorage.setItem('vault_token', data.token); // –°–æ—Ö—Ä–∞–Ω—è–µ–º "–ø–∞—Å–ø–æ—Ä—Ç"
            localStorage.setItem('vault_user', JSON.stringify(data.user));
            location.reload(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º, —á—Ç–æ–±—ã UI –æ–±–Ω–æ–≤–∏–ª—Å—è
        } else {
            document.getElementById('auth-msg').innerText = "–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞";
        }
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }
    async function register() {
        const login = document.getElementById('loginInput').value;
        const password = document.getElementById('passwordInput').value;

        const response = await fetch('/api/auth/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ login, password })
        });

        if (response.ok) {
            alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.");
        } else {
            const error = await response.text();
            alert("–û—à–∏–±–∫–∞: " + error);
        }
    }
    async function deleteUser(userId) {
        if (!confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?")) return;

        const res = await apiRequest(`/api/admin/users/${userId}`, 'DELETE');
        if (res.ok) {
            alert("–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω");
            loadAdminData(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫
        } else {
            const err = await res.text();
            alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: " + err);
        }
    }
    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
    window.onload = async () => {
        const userJson = localStorage.getItem('vault_user');
        if (!userJson) return;

        const user = JSON.parse(userJson);
        const lvl = user.accessLevel;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω—É–∂–Ω—ã–µ –±–ª–æ–∫–∏
        document.getElementById('auth-panel').classList.add('hidden');
        document.getElementById('profile-panel').classList.remove('hidden');
        document.getElementById('files-panel').classList.remove('hidden');
        
        document.getElementById('welcomeText').innerText = `–ü—Ä–∏–≤–µ—Ç, ${user.login}!`;
        document.getElementById('userLevel').innerText = lvl;

        // –†–ê–ó–ì–†–ê–ù–ò–ß–ï–ù–ò–ï –î–û–°–¢–£–ü–ê –í –ò–ù–¢–ï–†–§–ï–ô–°–ï
        if (lvl >= 3) {
            document.getElementById('upload-section').classList.remove('hidden');
        }

        if (lvl === 5) {
            document.getElementById('admin-panel').classList.remove('hidden');
            loadAdminData();
        }
        
        loadFilesStub(lvl);
    };

    async function loadAdminData() {
        const res = await apiRequest('/api/admin/users');
        if (res.ok) {
            const users = await res.json();
            const tbody = document.getElementById('usersTable');
            tbody.innerHTML = users.map(u => `
                    <tr>
                        <td>${u.id}</td>
                        <td>${u.login}</td>
                        <td><input type="number" value="${u.accessLevel}" id="lvl-${u.id}" style="width:50px"></td>
                        <td>
                            <button onclick="changeLevel(${u.id})" class="btn-success">–û–ö</button>
                            <button onclick="deleteUser(${u.id})" class="btn-danger" style="padding: 5px 10px;">–£–¥–∞–ª–∏—Ç—å</button>
                        </td>
                    </tr>
            `).join('');
        }
    }

    async function changeLevel(userId) {
        const newLvl = document.getElementById(`lvl-${userId}`).value;
        const res = await apiRequest(`/api/admin/users/${userId}/access`, 'PUT', parseInt(newLvl));
        if (res.ok) alert("–£—Ä–æ–≤–µ–Ω—å –∏–∑–º–µ–Ω–µ–Ω!");
    }

    function loadFilesStub(lvl) {
        const list = document.getElementById('file-list');
        list.innerHTML = `
            <div class="file-item">
                <span>üìÑ –û–±—â–∏–π_–æ—Ç—á–µ—Ç.pdf</span>
                <button>–°–∫–∞—á–∞—Ç—å</button>
            </div>
            ${lvl >= 4 ? `
            <div class="file-item" style="color: blue;">
                <span>üîí –°–µ–∫—Ä–µ—Ç–Ω—ã–π_–∞—Ä—Ö–∏–≤.zip (–¢–æ–ª—å–∫–æ –¥–ª—è lvl 4+)</span>
                <button>–°–∫–∞—á–∞—Ç—å</button>
            </div>` : ''}
        `;
    }
</script>
</body>
</html>